

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Bpod interaction &mdash; pybpod 1.2.0.beta documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="pybpod 1.2.0.beta documentation" href="../index.html"/>
        <link rel="next" title="Developing plugins" href="developing_plugins.html"/>
        <link rel="prev" title="GUI Windows" href="gui_windows.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> pybpod
          

          
          </a>

          
            
            
              <div class="version">
                1.2.0.beta
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html#run">Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html#update">Update</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/basic-usage.html">Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/writing-protocols.html">Writing a protocol for Bpod</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Developers</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gui_explained.html">GUI explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="gui_windows.html">GUI Windows</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Bpod interaction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#multiprocessing">Multiprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-protocol-on-bpod">Starting protocol on Bpod</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developing_plugins.html">Developing plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<p class="caption"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/about.html">Project Info</a></li>
</ul>
<p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contents.html">Indices and tables</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pybpod</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Bpod interaction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developers/bpod_interaction.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="bpod-interaction">
<span id="bpod-communication-label"></span><h1>Bpod interaction<a class="headerlink" href="#bpod-interaction" title="Permalink to this headline">¶</a></h1>
<dl class="docutils">
<dt>On this page you will learn:</dt>
<dd><ul class="first last simple">
<li>How multiprocessing works</li>
<li>How GUI handles protocols and communicates with Bpod</li>
<li>How messages from bpod since “_publish_data” go to the multiprocessing queue until they are parsed on the factory</li>
</ul>
</dd>
</dl>
<div class="section" id="multiprocessing">
<h2>Multiprocessing<a class="headerlink" href="#multiprocessing" title="Permalink to this headline">¶</a></h2>
<p>PyBpod GUI allows to control several Bpod boxes from a single application.
To achieve parallel execution, we use <a class="reference external" href="http://doc.qt.io/qt-5/thread-basics.html">Qt Threads</a> to avoid interface from freezing and <a class="reference external" href="https://docs.python.org/3.5/library/multiprocessing.html">Python3 multiprocessing</a> for getting the most out of computer CPU parallelization capabilities.</p>
<p>For each setup you run a protocol, a new Qt Thread and a process child will be created and get allocated to a single Bpod connection. This ensures the maximum performance. Moreover, if a Bpod box fails, the other Bpod boxes are not affected.</p>
<a class="reference internal image-reference" href="../_images/gui-multiprocessing-highlevel.svg"><img alt="../_images/gui-multiprocessing-highlevel.svg" src="../_images/gui-multiprocessing-highlevel.svg" /></a>
</div>
<div class="section" id="starting-protocol-on-bpod">
<h2>Starting protocol on Bpod<a class="headerlink" href="#starting-protocol-on-bpod" title="Permalink to this headline">¶</a></h2>
<p>From the moment you press the button “run” on the GUI until output shows up in the console and it is saved on session history file, a lot of stuff is going on.
First, let’s see how the GUI handles the “run” button. SetupWindow class is responsible for painting the setup window, including input fields and buttons.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SetupWindow</span><span class="p">(</span><span class="n">Setup</span><span class="p">,</span> <span class="n">BaseWidget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define here which fields from the setup model should appear on the details section.</span>

<span class="sd">    The model fields shall be defined as UI components like text fields, buttons, combo boxes, etc.</span>

<span class="sd">    You may also assign actions to these components.</span>

<span class="sd">    (...)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">BaseWidget</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Experiment&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">ControlText</span><span class="p">(</span><span class="s1">&#39;Subject name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_board</span> <span class="o">=</span> <span class="n">ControlCombo</span><span class="p">(</span><span class="s1">&#39;Box&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_task_btn</span> <span class="o">=</span> <span class="n">ControlButton</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">)</span>

        <span class="n">Setup</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reload_boards</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_formset</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;_name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_board&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_run_protocol_btn&#39;</span><span class="p">),</span>
            <span class="s1">&#39; &#39;</span>
        <span class="p">]</span>

        <span class="p">(</span><span class="o">...</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_protocol_btn</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_protocol</span>

        <span class="k">def</span> <span class="nf">_run_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Defines behavior of the button :attr:`SetupWindow._run_task_btn`.</span>

<span class="sd">            This methods is called every time the user presses the run button.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SetupWindow</span><span class="o">.</span><span class="n">STATUS_RUNNING_PROTOCOL_HANDLER</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stop_protocol</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SetupWindow</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_protocol</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">RunSetupError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Warning&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Unexpected Error&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
</pre></div>
</div>
<p>The “run” button click event will fire a complex sequence of calls. Detail explanation of this process is out of scope of this tutorial. However, the  following diagram resumes this process. What is important to retain is that the pybpod GUI library makes us of the Pybranch library to handle Qt Threads and python multiprocessing. Notice how inheritance is used for several classes to promote code reusability and separating concepts.</p>
<a class="reference internal image-reference" href="../_images/gui-bpod-communication.svg"><img alt="../_images/gui-bpod-communication.svg" src="../_images/gui-bpod-communication.svg" /></a>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="developing_plugins.html" class="btn btn-neutral float-right" title="Developing plugins" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="gui_windows.html" class="btn btn-neutral" title="GUI Windows" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Scientific Sofware Platform (CF).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.2.0.beta',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>