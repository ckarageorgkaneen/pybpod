

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Developing plugins &mdash; pybpod 1.2.0.beta documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="pybpod 1.2.0.beta documentation" href="../index.html"/>
        <link rel="next" title="Contributing" href="contributing.html"/>
        <link rel="prev" title="Bpod interaction" href="bpod_interaction.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> pybpod
          

          
          </a>

          
            
            
              <div class="version">
                1.2.0.beta
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html#run">Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html#update">Update</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/basic-usage.html">Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/writing-protocols.html">Writing a protocol for Bpod</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Developers</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gui_explained.html">GUI explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="gui_windows.html">GUI Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpod_interaction.html">Bpod interaction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developing plugins</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-a-pybpod-gui-plugin">What is a PyBpod GUI plugin?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#session-history-plugin-an-example">Session history plugin, an example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#quick-review-on-sessions">Quick review on sessions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parsing-board-messages">Parsing board messages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#register-plugin-on-the-gui">Register plugin on the GUI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connecting-the-plugin-with-a-session-node">Connecting the plugin with a session node</a></li>
<li class="toctree-l3"><a class="reference internal" href="#handling-session-history-from-the-plugin">Handling session history from the plugin</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<p class="caption"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/about.html">Project Info</a></li>
</ul>
<p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contents.html">Indices and tables</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pybpod</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Developing plugins</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developers/developing_plugins.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="developing-plugins">
<span id="developing-plugins-label"></span><h1>Developing plugins<a class="headerlink" href="#developing-plugins" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-a-pybpod-gui-plugin">
<h2>What is a PyBpod GUI plugin?<a class="headerlink" href="#what-is-a-pybpod-gui-plugin" title="Permalink to this headline">¶</a></h2>
<p><strong>PyBpod</strong> relies on a generic GUI framework, called <strong>PyformsGenericEditor</strong> which offers a basic user interface and can be extended to provide specific functionality through the installation of plugins.</p>
<dl class="docutils">
<dt>You can use plugins for:</dt>
<dd><ul class="first last simple">
<li>extending or overwriting PyBpod core concepts (e.g., experiments, subjects, boxes);</li>
<li>creating new visualization tools for PyBpod sessions (e.g., plots, message filters);</li>
<li>adding new windows, tools or any other UI-related functionality;</li>
</ul>
</dd>
</dl>
<p>Each plugin will be associated with a specific element of <strong>PyformsGenericEditor</strong> (e.g., project tree node, menu option, workspace area, etc).</p>
</div>
<div class="section" id="session-history-plugin-an-example">
<h2>Session history plugin, an example<a class="headerlink" href="#session-history-plugin-an-example" title="Permalink to this headline">¶</a></h2>
<p>This plugin allows you to display session data in a table view and you can order events by column.</p>
<p><a class="reference external" href="https://bitbucket.org/fchampalimaud/pybpod-gui-plugin-session-history">https://bitbucket.org/fchampalimaud/pybpod-gui-plugin-session-history</a></p>
<a class="reference internal image-reference" href="_images/basic-usage/session_history.png"><img alt="_images/basic-usage/session_history.png" src="_images/basic-usage/session_history.png" /></a>
<div class="section" id="quick-review-on-sessions">
<h3>Quick review on sessions<a class="headerlink" href="#quick-review-on-sessions" title="Permalink to this headline">¶</a></h3>
<p>Each time you run a Bpod protocol on a subject, a new session is created. The GUI collects output from the PyBpod API and processes these events on a list (which we call session history).
Besides being on memory, this history is automatically saved on a text file, so you never loose Bpod data.</p>
<p>If you navigate to your project on the filesystem, and locate the desired subject, you should find several files:</p>
<blockquote>
<div><ul class="simple">
<li>CSV and JSON are default outputs from the pybpod-api (for example, you can open CSV on excel and quickly produce some plots)</li>
<li>Plain text file is the output from the GUI</li>
</ul>
</div></blockquote>
<a class="reference internal image-reference" href="../_images/session_data_filesystem.png"><img alt="../_images/session_data_filesystem.png" src="../_images/session_data_filesystem.png" style="width: 1069.0px; height: 269.0px;" /></a>
<p>Let’s take a look at a plain text file which was output from running a protocol on the GUI.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>print_statement, 2017-05-23T15:41:29.638353, Trial:
print_statement, 2017-05-23T15:41:29.654188, Waiting for poke. Reward:
event_occurrence, 2017-05-23T15:41:33.672094, 50, Port2In, 2017-05-23 15:41:33.672094
event_occurrence, 2017-05-23T15:41:33.771925, 88, Tup, 2017-05-23 15:41:33.771925
state_entry, 2017-05-23T15:41:41.324848, 3, WaitForResponse, 4.1312, 4.3405
state_entry, 2017-05-23T15:41:41.324861, 4, Punish, 4.3405, 11.6663
state_entry, 2017-05-23T15:41:41.324908, 5, Reward, nan, nan
state_change, 2017-05-23T15:41:41.324930, 1, Port2In, 4.0312
state_change, 2017-05-23T15:41:41.324939, 2, Tup, 4.1312
state_change, 2017-05-23T15:41:41.324947, 2, Tup, 11.6663
print_statement, 2017-05-23T15:41:42.317543, Current trial info: {&#39;Bpod start timestamp&#39;: 0.011, &#39;States timestamps&#39;: {&#39;WaitForPort2Poke&#39;: [(0, 4.0312)], &#39;FlashStimulus&#39;: [(4.0312, 4.1312)], &#39;WaitForResponse&#39;: [(4.1312, 4.3405)], &#39;Punish&#39;: [(4.3405, 11.6663)], &#39;Reward&#39;: [(nan, nan)]}, &#39;Events timestamps&#39;: {&#39;Port2In&#39;: [4.0312], &#39;Tup&#39;: [4.1312, 11.6663], &#39;Port2Out&#39;: [4.3405], &#39;Port3In&#39;: [8.6663], &#39;Port3Out&#39;: [8.8762]}}
print_statement, 2017-05-23T15:41:42.322411, Trial:
print_statement, 2017-05-23T15:41:42.325805, Waiting for poke. Reward:
event_occurrence, 2017-05-23T15:41:48.035732, 48, Port1In, 2017-05-23 15:41:48.035732
event_occurrence, 2017-05-23T15:41:48.136440, 88, Tup, 2017-05-23 15:41:48.136440
state_entry, 2017-05-23T15:41:48.160769, 3, WaitForResponse, 3.2538, 3.4102
state_entry, 2017-05-23T15:41:48.160775, 4, Reward, 3.4102, 5.8133
state_entry, 2017-05-23T15:41:48.160781, 5, Punish, nan, nan
state_change, 2017-05-23T15:41:48.160791, 1, Port2In, 3.1538
state_change, 2017-05-23T15:41:48.160804, 3, Port2Out, 3.4102
state_change, 2017-05-23T15:41:48.160808, 4, Port1In, 5.7133
print_statement, 2017-05-23T15:41:49.142529, Current trial info: {&#39;Bpod start timestamp&#39;: 12.689, &#39;States timestamps&#39;: {&#39;WaitForPort2Poke&#39;: [(0, 3.1538)], &#39;FlashStimulus&#39;: [(3.1538, 3.2538)], &#39;WaitForResponse&#39;: [(3.2538, 3.4102)], &#39;Reward&#39;: [(3.4102, 5.8133)], &#39;Punish&#39;: [(nan, nan)]}, &#39;Events timestamps&#39;: {&#39;Port2In&#39;: [3.1538], &#39;Tup&#39;: [3.2538, 5.8133], &#39;Port2Out&#39;: [3.4102], &#39;Port1In&#39;: [5.7133]}}
print_statement, 2017-05-23T15:41:49.147563, Trial:
print_statement, 2017-05-23T15:41:49.151724, Waiting for poke. Reward:
event_occurrence, 2017-05-23T15:41:52.731798, 50, Port2In, 2017-05-23 15:41:52.731798
event_occurrence, 2017-05-23T15:41:53.845332, 48, Port1In, 2017-05-23 15:41:53.845332
event_occurrence, 2017-05-23T15:41:53.946396, 88, Tup, 2017-05-23 15:41:53.946396
state_entry, 2017-05-23T15:41:53.974354, 1, WaitForPort2Poke, 0, 3.5869
state_entry, 2017-05-23T15:41:53.974475, 5, Punish, nan, nan
state_change, 2017-05-23T15:41:53.974495, 1, Port2In, 3.5869
state_change, 2017-05-23T15:41:53.974536, 3, Port2Out, 3.8881
state_change, 2017-05-23T15:41:53.974545, 4, Port1In, 4.7007
print_statement, 2017-05-23T15:41:54.955371, Current trial info: {&#39;Bpod start timestamp&#39;: 19.513, &#39;States timestamps&#39;: {&#39;WaitForPort2Poke&#39;: [(0, 3.5869)], &#39;FlashStimulus&#39;: [(3.5869, 3.6869)], &#39;WaitForResponse&#39;: [(3.6869, 3.8881)], &#39;Reward&#39;: [(3.8881, 4.8007)], &#39;Punish&#39;: [(nan, nan)]}, &#39;Events timestamps&#39;: {&#39;Port2In&#39;: [3.5869], &#39;Tup&#39;: [3.6869, 4.8007], &#39;Port2Out&#39;: [3.8881], &#39;Port1In&#39;: [4.7007]}}
</pre></div>
</div>
<p>What is going on here? Each line is a new message, where the first column identifies the type of an event on the session history: it can be a bpod state change, state entry, a user print, etc.
These events represent messages that were sent from the Bpod and processed by the GUI.</p>
</div>
<div class="section" id="parsing-board-messages">
<h3>Parsing board messages<a class="headerlink" href="#parsing-board-messages" title="Permalink to this headline">¶</a></h3>
<p>Currently, PyBpod GUI supports the following events from Bpod board:</p>
<table border="1" class="docutils">
<colgroup>
<col width="39%" />
<col width="13%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Session History Event Type</th>
<th class="head">Occurs during trial run?</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><span class="xref std std-ref">Event occurrence</span></td>
<td>YES</td>
<td>Any Bpod event during trial run</td>
</tr>
<tr class="row-odd"><td><span class="xref std std-ref">State change</span></td>
<td>NO</td>
<td>Events detected by Bpod’s inputs can be set to trigger transitions between specific states.</td>
</tr>
<tr class="row-even"><td><span class="xref std std-ref">State entry</span></td>
<td>NO</td>
<td>State entered during the state matrix run</td>
</tr>
<tr class="row-odd"><td><span class="xref std std-ref">Print statement</span></td>
<td>YES</td>
<td>User defined print messages on protocol</td>
</tr>
</tbody>
</table>
<p>All these classes represent board messages and inherit a generic class <span class="xref std std-ref">BoardMessage</span>.
For more information on how the GUI parses these messages, see <span class="xref std std-ref">Message factory</span>.</p>
</div>
<div class="section" id="register-plugin-on-the-gui">
<h3>Register plugin on the GUI<a class="headerlink" href="#register-plugin-on-the-gui" title="Permalink to this headline">¶</a></h3>
<p>The first thing you need to do is to register your plugin. For that, edit your user settings. From the top menu, go to <strong>Options &gt; Edit user settings</strong>.
Edit the <code class="xref py py-class docutils literal"><span class="pre">GENERIC_EDITOR_PLUGINS_PATH</span></code> variable as this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    <span class="n">GENERIC_EDITOR_PLUGINS_LIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;pybpodgui_plugin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pybpodgui_plugin_session_history&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<dl class="docutils">
<dt>For the GUI to be able to detect the plugin source code you have 2 options:</dt>
<dd><ol class="first last arabic simple">
<li>Download the plugin folder you want and place it on the “plugins” folder you have just indicated before (useful when you run pybpod GUI as an executable)</li>
<li>Install the plugin with PIP (only applies if you are running the GUI from source code).</li>
</ol>
</dd>
</dl>
<p>On this example, we will assume option #2 since we will be developing a plugin from the source code.
In that case, you may leave the <code class="xref py py-class docutils literal"><span class="pre">GENERIC_EDITOR_PLUGINS_PATH</span> <span class="pre">=</span> <span class="pre">None</span></code> because the plugin will be already on the Python path.
<strong>But don’t forget! Every time you make changes to the plugin you have to install it with PIP again (unless your IDE does that for you).</strong></p>
<p>Finally, restart the GUI. The Session History plugin is a type of plugin that will be connected to a session and extend its behavior.
Thus, after installing this plugin, you will see a new option by right-clicking a session node in the project tree. But how this works?</p>
</div>
<div class="section" id="connecting-the-plugin-with-a-session-node">
<h3>Connecting the plugin with a session node<a class="headerlink" href="#connecting-the-plugin-with-a-session-node" title="Permalink to this headline">¶</a></h3>
<p>Every node on the project tree node has a window assigned to it.
In order to plugins show up on a project tree node, we need to extend the corresponing node window behavior.
For example:</p>
<blockquote>
<div><ul class="simple">
<li>an experiment node is connected to the <code class="xref py py-class docutils literal"><span class="pre">pybpodgui_api.models.experiment.experiment_treenode.ExperimentTreeNode</span></code> class</li>
<li>a board node is connected to the <code class="xref py py-class docutils literal"><span class="pre">pybpodgui_api.models.board.board_treenode.BoardTreeNode</span></code> class</li>
<li>a session node is connected to the <code class="xref py py-class docutils literal"><span class="pre">pybpodgui_api.models.session.session_treenode.SessionTreeNode</span></code> class</li>
</ul>
</div></blockquote>
<p>The <strong>PyformsGenericEditor</strong> enables that all these classes may be extended by looking for classes on plugins that have the same name and path.</p>
<p>On the Session History plugin, since we want to override session behavior we need to have the following structrure:</p>
<a class="reference internal image-reference" href="../_images/module_session_treenode.png"><img alt="../_images/module_session_treenode.png" src="../_images/module_session_treenode.png" style="width: 274.0px; height: 306.0px;" /></a>
<p>On the <em>models.session.__init__.py</em> module, you must define the class that will override the original SessionTreeNode class.
If you inspect the <em>__init__.py</em> you will find this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pybpodgui_plugin_session_history.models.session.session_treenode</span> <span class="k">import</span> <span class="n">SessionTreeNode</span> <span class="k">as</span> <span class="n">Session</span>
</pre></div>
</div>
<p>By using Python inheritance, <strong>PyformsGenericEditor</strong> discovers that <em>SessionTreeNode</em> will match the original class from the GUI.</p>
<p>On the <em>session_treenode.py</em> file on our plugin, one can now redefine the behavior of the desired methods. In this case, we are overriding the
<em>create_treenode</em> method to add a new option when the user right-clicks the project tree node.
We also override other methods to personalize details such as window title or double-clicking.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pybpodgui_plugin_session_history.session_history</span> <span class="kn">import</span> <span class="n">SessionHistory</span>

<span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SessionTreeNode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_treenode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extends create_treenode behavior by calling the parent and adding a new option</span>
<span class="sd">        when user right-clicks the node.</span>

<span class="sd">        See also: pybpodgui_api.models.session.session_treenode.SessionTreeNode.create_treenode</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SessionTreeNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create_treenode</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="n">tree</span><span class="o">.</span><span class="n">add_popup_menu_option</span><span class="p">(</span><span class="s1">&#39;History&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_session_history_plugin</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span>
                                   <span class="n">icon</span><span class="o">=</span><span class="n">QIcon</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">SESSIONLOG_PLUGIN_ICON</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">node_double_clicked_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SessionTreeNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">node_double_clicked_event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_session_history_plugin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">open_session_history_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;session_history_plugin&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_history_plugin</span> <span class="o">=</span> <span class="n">SessionHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_history_plugin</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_history_plugin</span><span class="o">.</span><span class="n">subwindow</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="o">*</span><span class="n">conf</span><span class="o">.</span><span class="n">SESSIONLOG_PLUGIN_WINDOW_SIZE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_history_plugin</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;session_history_plugin&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainwindow</span><span class="o">.</span><span class="n">mdi_area</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history_plugin</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SessionTreeNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SessionTreeNode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@name.setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SessionTreeNode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;session_history_plugin&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history_plugin</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>
</div>
<p>This should be the final result:</p>
<a class="reference internal image-reference" href="../_images/session_node_history.png"><img alt="../_images/session_node_history.png" src="../_images/session_node_history.png" style="width: 646.0px; height: 551.0px;" /></a>
</div>
<div class="section" id="handling-session-history-from-the-plugin">
<h3>Handling session history from the plugin<a class="headerlink" href="#handling-session-history-from-the-plugin" title="Permalink to this headline">¶</a></h3>
<p>On the previous section, we defined a new action for the session node.
We have done that by linking the “History” menu option to the method <em>open_session_history_plugin</em>.
Inside this method we invoke a class from the <em>session_history.py</em> module.</p>
<p>The <em>session_history.py</em> is responsible for creating a new window that shows up in the GUI workspace.
This window must inherit from <em>BaseWidget</em> in order to make use of the necessary PyForms controls.</p>
<p>Since the GUI holds session history on memory, a list of board messages, session plugins can easily access to this list and process the events as needed.
In our window, we will define a ControlList to list all the session history events. We will then define a timer that fires periodically to check for new messages and update the list.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyforms</span> <span class="kn">import</span> <span class="n">BaseWidget</span>
<span class="kn">from</span> <span class="nn">pyforms.Controls</span> <span class="kn">import</span> <span class="n">ControlProgress</span>
<span class="kn">from</span> <span class="nn">pyforms.Controls</span> <span class="kn">import</span> <span class="n">ControlList</span>

<span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pybpodgui_plugin.com.messaging</span> <span class="kn">import</span> <span class="n">ErrorMessage</span>
<span class="kn">from</span> <span class="nn">pybpodgui_plugin.com.messaging</span> <span class="kn">import</span> <span class="n">PrintStatement</span>
<span class="kn">from</span> <span class="nn">pybpodgui_plugin.com.messaging</span> <span class="kn">import</span> <span class="n">StateChange</span>
<span class="kn">from</span> <span class="nn">pybpodgui_plugin.com.messaging</span> <span class="kn">import</span> <span class="n">StateEntry</span>
<span class="kn">from</span> <span class="nn">pybpodgui_plugin.com.messaging</span> <span class="kn">import</span> <span class="n">EventOccurrence</span>

<span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SessionHistory</span><span class="p">(</span><span class="n">BaseWidget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plugin main window &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="p">(</span><span class="o">...</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">ControlList</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_formset</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;_log&#39;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_history_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">horizontal_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Channel Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="s1">&#39;End&#39;</span><span class="p">,</span> <span class="s1">&#39;PC timestamp&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">set_sorting_enabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="p">(</span><span class="o">...</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_message_queue</span><span class="p">)</span>

    <span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_message_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_gui</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update board queue and retrieve most recent messages &quot;&quot;&quot;</span>
        <span class="n">messages_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">messages_history</span>
        <span class="n">recent_history</span> <span class="o">=</span> <span class="n">messages_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_index</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">update_gui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">recent_history</span><span class="p">:</span>

                <span class="n">table_line</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">StateChange</span><span class="p">):</span>
                    <span class="n">table_line</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_index</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">MESSAGE_TYPE_ALIAS</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">event_name</span><span class="p">,</span>
                                  <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">board_timestamp</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">board_timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">pc_timestamp</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">StateEntry</span><span class="p">):</span>
                    <span class="n">table_line</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_index</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">MESSAGE_TYPE_ALIAS</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">state_name</span><span class="p">,</span>
                                  <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">start_timestamp</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">end_timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">pc_timestamp</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">EventOccurrence</span><span class="p">):</span>
                    <span class="n">table_line</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_index</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">MESSAGE_TYPE_ALIAS</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">event_name</span><span class="p">,</span>
                                  <span class="n">message</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">pc_timestamp</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">table_line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">+=</span> <span class="n">table_line</span>
                    <span class="n">QEventLoop</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">update_gui</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">99</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_history_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_timer&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;Unexpected error while loading session history. Pleas see log for more details.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_gui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>

    <span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>This should be the final result:</p>
<a class="reference internal image-reference" href="../_images/session_history_window_closeup.png"><img alt="../_images/session_history_window_closeup.png" src="../_images/session_history_window_closeup.png" style="width: 702.0px; height: 707.0px;" /></a>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="contributing.html" class="btn btn-neutral float-right" title="Contributing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bpod_interaction.html" class="btn btn-neutral" title="Bpod interaction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Scientific Sofware Platform (CF).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.2.0.beta',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>